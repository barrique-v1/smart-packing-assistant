# Docker Deployment Guide

This guide explains how to build and run the Smart Packing Assistant using Docker and Docker Compose.

## Prerequisites

- Docker Desktop 20.10+ (Windows/Mac) or Docker Engine (Linux)
- Docker Compose 2.0+
- OpenAI API Key
- Python 3.9+ (for Qdrant import script)

## Quick Start

### 1. Set up environment variables

Edit the `.env` file in the project root and add your OpenAI API key:

```bash
# .env
OPENAI_API_KEY=sk-your-actual-openai-api-key-here
POSTGRES_DB=NAME
POSTGRES_USER=USER
POSTGRES_PASSWORD=PASSWORD
```

**Important**: The `.env.example` file is provided as a template. Copy it to `.env` and replace `sk-your-actual-openai-api-key-here` with your actual OpenAI API key.

### 2. Build all services

```bash
docker compose build
```

This will build:
- `postgres` (PostgreSQL 15 database)
- `qdrant` (Qdrant vector database for RAG)
- `ai-worker` (AI Worker service on port 8081)
- `api-gateway` (API Gateway service on port 8080)
- `frontend` (React frontend on port 5173)

**Note**: The first build will take 10-15 minutes as it downloads dependencies and compiles the Kotlin code.

### 3. Start all services

```bash
docker compose up -d
```

This starts all containers in detached mode.

### 4. Check service health

```bash
# View all running containers
docker compose ps

# Check logs
docker compose logs -f

# Check specific service logs
docker compose logs -f api-gateway
docker compose logs -f ai-worker
docker compose logs -f postgres
docker compose logs -f qdrant
docker compose logs -f frontend
```

### 5. Wait for services to be ready

The services have health checks configured. Wait 60-90 seconds for all services to become healthy:

```bash
# Check health status
docker compose ps

# Expected output:
# NAME                  STATUS
# packing-postgres      Up (healthy)
# packing-ai-worker     Up (healthy)
# packing-api-gateway   Up (healthy)
# packing-frontend      Up (healthy)
# packing-qdrant        Up (healthy)
```

### 6. Initialize Qdrant Vector Database

The AI Worker uses Qdrant for RAG (Retrieval-Augmented Generation). You need to import the packing knowledge embeddings:

```bash
# Install Python dependencies (if not already installed)
pip3 install requests tqdm

# Import embeddings to Qdrant
python3 scripts/import-to-qdrant.py --recreate
```

Expected output:
```
✅ Loaded 140 points from file
✅ Qdrant is healthy and accessible
✅ Collection 'packing_knowledge' created successfully
✅ Successfully uploaded 140 points
✅ Import verified successfully - all 140 points imported
```

**Note**: This step is required for RAG-enhanced packing list generation. Without it, the AI Worker will fall back to pure GPT generation (which still works but is less accurate).

### 7. Access the frontend

Open your browser and navigate to:
- Frontend: http://localhost:5173

Happy packing! :)

Other service health check endpoints:
- API Gateway: http://localhost:8080/api/packing/health
- AI Worker: http://localhost:8081/api/ai/health
- Qdrant Dashboard: http://localhost:6333/dashboard

## Architecture

The Docker Compose setup includes:

1. **PostgreSQL Database** (`postgres`)
   - Port: 5432
   - Database: `packing_assistant`
   - Persistent volume: `postgres-data`
   - Health check: `pg_isready`

2. **Qdrant Vector Database** (`qdrant`)
   - Ports: 6333 (HTTP), 6334 (gRPC)
   - Collection: `packing_knowledge` (140 vectors)
   - Used for RAG-enhanced packing recommendations
   - Dashboard: http://localhost:6333/dashboard
   - Persistent volume: `qdrant-data`

3. **AI Worker** (`ai-worker`)
   - Port: 8081
   - Handles OpenAI API calls and vector search
   - Connects to Qdrant for RAG
   - Requires: `OPENAI_API_KEY` environment variable
   - Health check: `/actuator/health`

4. **API Gateway** (`api-gateway`)
   - Port: 8080
   - Main REST API
   - Connects to PostgreSQL and AI Worker
   - Runs Flyway migrations on startup
   - Health check: `/actuator/health`

5. **Frontend** (`frontend`)
   - Port: 5173 (mapped to container port 80)
   - React + Vite application
   - Served by nginx
   - Health check: HTTP GET on `/`

## Service Dependencies

The services start in the following order:

1. `postgres` (no dependencies)
2. `qdrant` (no dependencies)
3. `ai-worker` (depends on `qdrant` being available)
4. `api-gateway` (depends on `postgres` and `ai-worker` being healthy)
5. `frontend` (depends on `api-gateway` being healthy)

**Note**: After all services are healthy, you must run the Qdrant import script (Step 6) to populate the vector database.

## Next Steps

After Docker is working:
- Deploy to Kubernetes (see `k8s/` directory)
