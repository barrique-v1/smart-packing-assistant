# Kubernetes Deployment Guide (Docker Desktop)

This guide explains how to deploy the **Smart Packing Assistant** to Kubernetes using **Docker Desktop's built-in Kubernetes cluster**.

## Additional Prerequisites to Docker Setup

- **kubectl** installed (usually comes with Docker Desktop)
- **Configured .env file** with your OpenAI API key (see `.env.example`)

**Note**: This guide uses an automated script (`./scripts/create-k8s-secrets.sh`) to generate Kubernetes secrets from your `.env` file.

- Please ensure to stop any running Docker Compose instances of the app before proceeding:
```bash
  docker compose down
```
---

## Quick Start

### 1. Enable Kubernetes in Docker Desktop

**macOS** & **Windows**:
1. Click Docker icon in menu bar â†’ **Settings** (gear icon)
2. Navigate to **Kubernetes** tab
3. **Enable Kubernetes** (kind + 1-node)
4. Click **Apply & Install**
5. Wait 2-3 minutes for Kubernetes to initialize

**Verify Kubernetes is running**:

Check context (should show docker-desktop)
```bash
  kubectl config current-context
```
Expected Output: docker-desktop

Verify cluster info
```bash 
  kubectl cluster-info
```
Output: Kubernetes control plane is running at https://kubernetes.docker.internal:6443

### 2. Set Up Secrets from .env

Ensure your `.env` file is configured with your OpenAI API key and database credentials:
```bash
# Check .env exists
cat .env
```

Expected content:
```
OPENAI_API_KEY=sk-your-actual-openai-api-key
POSTGRES_DB=packing_assistant
POSTGRES_USER=admin
POSTGRES_PASSWORD=secret123
```

**Create Kubernetes secrets automatically** using the helper script:
```bash
# Run the automated secret creation script
./scripts/create-k8s-secrets.sh
```

This script will:
- Validate your `.env` file
- Create the `packing-assistant` namespace (if needed)
- Create the `app-secrets` secret with your credentials

### 3. Build Docker Images and Pull Dependencies

**Build application images**:
```bash
  docker compose build
```

**Pull required base images** (for services and init containers):
```bash
  docker pull postgres:15-alpine
  docker pull qdrant/qdrant:v1.7.4
  docker pull busybox:1.36
```

**Verify images exist**:
```bash
  docker images | grep -E "smart-packing|postgres|qdrant|busybox"
```

**Expected output**:
```
smart-packing-assistant-api-gateway    latest    abc123    2 minutes ago    400MB
smart-packing-assistant-ai-worker      latest    def456    2 minutes ago    380MB
postgres                               15-alpine xxx        2 weeks ago        238MB
qdrant/qdrant                          v1.7.4    yyy        1 week ago         150MB
busybox                                1.36      zzz        5 days ago         2MB
```

### 4. Deploy to Kubernetes

**Deploy all services in order**:

```bash
# Deploy PostgreSQL (database for sessions/lists)
  kubectl apply -f k8s/02-postgres-pvc.yaml
  kubectl apply -f k8s/03-postgres-deployment.yaml
  kubectl apply -f k8s/04-postgres-service.yaml
  kubectl wait --for=condition=ready pod -l app=postgres -n packing-assistant --timeout=120s


# Step 3: Deploy Qdrant (vector database for RAG)
  kubectl apply -f k8s/11-qdrant-pvc.yaml
  kubectl apply -f k8s/12-qdrant-deployment.yaml
  kubectl apply -f k8s/13-qdrant-service.yaml
  kubectl wait --for=condition=ready pod -l app=qdrant -n packing-assistant --timeout=120s

# Step 4: Deploy AI Worker (GPT-4 + RAG)
  kubectl apply -f k8s/05-ai-worker-deployment.yaml
  kubectl apply -f k8s/06-ai-worker-service.yaml
  kubectl wait --for=condition=ready pod -l app=ai-worker -n packing-assistant --timeout=120s

# Step 5: Deploy API Gateway (REST API)
  kubectl apply -f k8s/07-api-gateway-deployment.yaml
  kubectl apply -f k8s/08-api-gateway-service.yaml
  kubectl wait --for=condition=ready pod -l app=api-gateway -n packing-assistant --timeout=120s

# Step 6: Deploy Frontend
  kubectl apply -f k8s/09-frontend-deployment.yaml
  kubectl apply -f k8s/10-frontend-service.yaml
  kubectl wait --for=condition=ready pod -l app=frontend -n packing-assistant --timeout=120s
```

### 5. Generate RAG Knowledge Base Embeddings & Import to Qdrant

**Install Python dependencies**:
```bash
  pip3 install openai tqdm
```

**Generate embeddings** (creates vector representations of 140 packing items):
```bash
  python3 scripts/generate-embeddings.py
```

The script automatically reads your OpenAI API key from the `.env` file - no manual export needed!

**Run port-forward in background and import embeddings**:
```bash
  # Start port forwarding in background
  kubectl port-forward -n packing-assistant service/qdrant 6333:6333 &

  # Wait for port-forward to be ready
  sleep 5

  # Import embeddings
  python3 scripts/import-to-qdrant.py --recreate

  # Cleanup port-forward
  pkill -f "port-forward.*qdrant"
```

### 6. Verify Deployment

Check all pods are running:
```bash
  kubectl get pods -n packing-assistant
```

Expected output (after 60-90 seconds):
```
NAME                           READY   STATUS    RESTARTS   AGE
postgres-xxx                   1/1     Running   0          3m
qdrant-xxx                     1/1     Running   0          2m
ai-worker-xxx                  1/1     Running   0          2m
api-gateway-xxx                1/1     Running   0          1m
frontend-xxx                   1/1     Running   0          1m
```

Check services:
```bash
  kubectl get services -n packing-assistant
```

Expected output:
```
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
postgres      ClusterIP   10.96.x.x       <none>        5432/TCP         3m
qdrant        ClusterIP   10.96.x.x       <none>        6333/TCP         2m
ai-worker     ClusterIP   10.96.x.x       <none>        8081/TCP         2m
api-gateway   NodePort    10.96.x.x       <none>        8080:30080/TCP   1m
frontend      NodePort    10.96.x.x       <none>        80:30173/TCP     1m
```

### 7. Access and Test the Application

**Set up port forwarding** (macOS):

Frontend (access the UI):
```bash
  kubectl port-forward -n packing-assistant service/frontend 5173:80
```

API Gateway (for testing API endpoints):
```bash
  kubectl port-forward -n packing-assistant service/api-gateway 8080:8080
```

**Test health endpoint**:
```bash
  curl http://localhost:8080/api/packing/health
```
Expected: `{"status":"UP"}`

### 8. **Access the Frontend UI**

Go To [http://localhost:5173](http://localhost:5173) in your browser to access the Smart Packing Assistant UI.

### Happy packing! :)



